import nmap
import requests

def scan_target(target):
    """
    Scans the target IP address for open ports and services using nmap.
    """
    nm = nmap.PortScanner()
    print(f"Scanning {target}...")
    nm.scan(target, arguments='-sV')
    
    scan_results = {}
    
    for host in nm.all_hosts():
        print(f"Host: {host} ({nm[host].hostname()})")
        print(f"State: {nm[host].state()}")
        scan_results[host] = []
        
        for proto in nm[host].all_protocols():
            ports = nm[host][proto].keys()
            for port in ports:
                service_name = nm[host][proto][port]['name']
                product = nm[host][proto][port].get('product', '')
                version = nm[host][proto][port].get('version', '')
                
                print(f"Port: {port}/{proto}, Service: {service_name}, Product: {product}, Version: {version}")
                
                scan_results[host].append({
                    'port': port,
                    'service': service_name,
                    'product': product,
                    'version': version
                })
    
    return scan_results

def get_cve_data(service_name, version):
    """
    Fetch CVE data for a service name and version from the CIRCL CVE Search API.
    """
    cve_api_url = f"https://cve.circl.lu/api/search/{service_name}/{version}"
    
    # Send a request to the CVE API
    response = requests.get(cve_api_url)
    
    if response.status_code == 200:
        cve_data = response.json()
        if cve_data:
            return cve_data
    return []

def check_vulnerabilities(scan_results):
    """
    Cross-references the services found in the scan results with CVEs.
    """
    for host, services in scan_results.items():
        print(f"\nChecking vulnerabilities for {host}...")
        
        for service in services:
            service_name = service['service']
            version = service['version']

            # Fetch CVE data for the service and version
            cve_data = get_cve_data(service_name, version)

            if cve_data:
                print(f"Vulnerabilities for {service_name} {version}:")
                for cve in cve_data:
                    print(f"  - {cve['id']}: {cve['summary']}")
            else:
                print(f"No vulnerabilities found for {service_name} {version}")

def generate_report(scan_results, report_file="vulnerability_report.txt"):
    """
    Generates a report of the scan results and CVE vulnerabilities in a text file.
    """
    with open(report_file, 'w') as f:
        for host, services in scan_results.items():
            f.write(f"\nHost: {host}\n")
            for service in services:
                service_name = service['service']
                version = service['version']
                
                f.write(f"Service: {service_name} Version: {version}\n")
                
                # Fetch CVE data for the service and version
                cve_data = get_cve_data(service_name, version)
                
                if cve_data:
                    f.write("Vulnerabilities:\n")
                    for cve in cve_data:
                        f.write(f"  - {cve['id']}: {cve['summary']}\n")
                else:
                    f.write("  No vulnerabilities found\n")
    
    print(f"Report generated: {report_file}")

if __name__ == "__main__":
    target_ip = "192.168.1.1"  # Replace with the target IP address or range
    results = scan_target(target_ip)
    check_vulnerabilities(results)
    generate_report(results)
